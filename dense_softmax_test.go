package tensor

import (
	"fmt"
	"testing"

	"github.com/stretchr/testify/assert"
)

func TestSoftMax(t *testing.T) {
	testCases := []struct {
		fn             func(x Tensor, axis int, opts ...FuncOpt) (Tensor, error)
		x              Tensor
		axis           int
		expectedOutput interface{}
	}{
		{
			fn: LogSoftMax,
			x: New(
				Of(Float64),
				WithShape(3, 4),
				WithBacking([]float64{0.0, 0.1, 0.2, 0.3, 0.4, 0.5, 0.6, 0.7, 0.8, 0.9, 1.0, 1.1}),
			),
			axis:           -1,
			expectedOutput: []float64{-1.5425355294551628, -1.4425355294551627, -1.3425355294551626, -1.2425355294551628, -1.5425355294551628, -1.4425355294551627, -1.3425355294551626, -1.2425355294551628, -1.5425355294551628, -1.4425355294551627, -1.3425355294551629, -1.2425355294551628},
		},
		{
			fn: LogSoftMax,
			x: New(
				Of(Float32),
				WithShape(3, 4),
				WithBacking([]float32{0.0, 0.1, 0.2, 0.3, 0.4, 0.5, 0.6, 0.7, 0.8, 0.9, 1.0, 1.1}),
			),
			axis:           -1,
			expectedOutput: []float32{-1.5425355294551628, -1.4425355294551627, -1.3425355294551626, -1.2425355294551628, -1.5425355294551628, -1.4425355294551627, -1.3425355294551626, -1.2425355294551628, -1.5425355294551628, -1.4425355294551627, -1.3425355294551629, -1.2425355294551628},
		},
		{
			fn: LogSoftMax,
			x: New(
				Of(Float32),
				WithShape(3, 2, 2),
				WithBacking([]float32{0.0, 0.1, 0.2, 0.3, 0.4, 0.5, 0.6, 0.7, 0.8, 0.9, 1.0, 1.1}),
			),
			axis:           -1,
			expectedOutput: []float32{-0.7443967, -0.64439666, -0.7443967, -0.64439666, -0.7443967, -0.64439666, -0.7443966, -0.64439666, -0.7443966, -0.64439666, -0.7443967, -0.64439666},
		},
		{
			fn: LogSoftMax,
			x: New(
				Of(Float64),
				WithShape(3, 2, 2),
				WithBacking([]float64{0.0, 0.1, 0.2, 0.3, 0.4, 0.5, 0.6, 0.7, 0.8, 0.9, 1.0, 1.1}),
			),
			axis:           1,
			expectedOutput: []float64{-0.7981388693815918, -0.7981388693815918, -0.5981388693815918, -0.5981388693815919, -0.7981388693815918, -0.7981388693815918, -0.5981388693815919, -0.5981388693815919, -0.7981388693815918, -0.7981388693815918, -0.5981388693815919, -0.5981388693815918},
		},
		{
			fn: SoftMax,
			x: New(
				Of(Float64),
				WithShape(3, 2, 2),
				WithBacking([]float64{0.0, 0.1, 0.2, 0.3, 0.4, 0.5, 0.6, 0.7, 0.8, 0.9, 1.0, 1.1}),
			),
			axis:           1,
			expectedOutput: []float64{0.4501660026875221, 0.45016600268752205, 0.549833997312478, 0.5498339973124778, 0.45016600268752205, 0.45016600268752205, 0.5498339973124778, 0.5498339973124778, 0.45016600268752205, 0.4501660026875221, 0.5498339973124778, 0.549833997312478},
		},
		{
			fn: SoftMax,
			x: New(
				Of(Float64),
				WithShape(3, 2, 2),
				WithBacking([]float64{0.0, 0.1, 0.2, 0.3, 0.4, 0.5, 0.6, 0.7, 0.8, 0.9, 1.0, 1.1}),
			),
			axis:           -1,
			expectedOutput: []float64{0.47502081252106, 0.52497918747894, 0.47502081252106, 0.5249791874789399, 0.47502081252106, 0.5249791874789399, 0.47502081252106, 0.5249791874789399, 0.47502081252106, 0.5249791874789399, 0.47502081252106, 0.52497918747894},
		},
		{
			fn: SoftMax,
			x: New(
				Of(Float32),
				WithShape(3, 4),
				WithBacking([]float32{0.0, 0.1, 0.2, 0.3, 0.4, 0.5, 0.6, 0.7, 0.8, 0.9, 1.0, 1.1}),
			),
			axis:           -1,
			expectedOutput: []float32{0.21383822, 0.23632777, 0.2611826, 0.2886514, 0.21383823, 0.23632778, 0.2611826, 0.2886514, 0.21383822, 0.23632777, 0.26118258, 0.2886514},
		},
		{
			fn: SoftMax,
			x: New(
				Of(Float64),
				WithShape(3, 4),
				WithBacking([]float64{0.0, 0.1, 0.2, 0.3, 0.4, 0.5, 0.6, 0.7, 0.8, 0.9, 1.0, 1.1}),
			),
			axis:           -1,
			expectedOutput: []float64{0.21383822, 0.23632777, 0.2611826, 0.2886514, 0.21383823, 0.23632778, 0.2611826, 0.2886514, 0.21383822, 0.23632777, 0.26118258, 0.2886514},
		},
	}
	for i, tC := range testCases {
		t.Run(fmt.Sprintf("Example #%d - %v %v", i+1, tC.x.Shape(), tC.x.Dtype()), func(t *testing.T) {
			c := assert.New(t)

			output, err := tC.fn(tC.x, tC.axis)
			t.Logf("output: %#v", output.Data())

			c.NoError(err)
			c.NotNil(output)

			c.Equal(tC.x.Shape(), output.Shape())
			c.InDeltaSlice(tC.expectedOutput, output.Data(), 1e-6)
		})
	}
}
